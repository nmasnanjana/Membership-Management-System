{% extends 'base.html' %}
{% load static %}

{% block head %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{% static 'DataTables/datatables.min.css' %}">
    <script src="{% static 'DataTables/datatables.min.js' %}"></script>
{% endblock head %}

{% block content %}
    <div class="container">
        {% if breadcrumb_items %}
            {% include 'breadcrumb.html' %}
        {% endif %}
        <div class="mb-4">
            <h1 class="page-title">
                <i class="fas fa-users text-primary me-2"></i>{% if is_adults_page %}Adults Directory{% else %}Members Directory{% endif %}
            </h1>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-modern alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'error' %}
                        <i class="fas fa-exclamation-circle me-2"></i>
                    {% else %}
                        <i class="fas fa-check-circle me-2"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="modern-card mb-4">
            <div class="modern-card-header d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>{% if is_adults_page %}All Adults (18+){% else %}All Members (Under 18){% endif %}
                </h5>
                <div class="d-flex gap-2 mt-2 mt-md-0">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-light btn-sm" id="viewToggle" data-view="table">
                            <i class="fas fa-table me-1"></i>Table
                        </button>
                        <button type="button" class="btn btn-light btn-sm" id="viewToggle" data-view="cards">
                            <i class="fas fa-th me-1"></i>Cards
                        </button>
                    </div>
                    <a class="btn btn-light btn-sm" href="{% url 'member_register' %}">
                        <i class="fas fa-user-plus me-1"></i> Add Member
                    </a>
                    {% if user.is_superuser %}
                        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
                            <i class="fas fa-download me-1"></i> Export
                        </button>
                    {% endif %}
                </div>
            </div>
            <div class="modern-card-body">
                <!-- Advanced Search & Filters -->
                <div class="mb-4 p-3 bg-dark rounded">
                    <form method="get" action="{% url 'member_list' %}" id="searchForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label text-light"><i class="fas fa-search me-1"></i>Search</label>
                                <input type="text" class="form-control" name="search" value="{{ search_query }}" 
                                       placeholder="Search by ID, name, phone, address...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-light"><i class="fas fa-toggle-on me-1"></i>Status</label>
                                <select class="form-select" name="is_active">
                                    <option value="">All</option>
                                    <option value="true" {% if is_active_filter == 'true' %}selected{% endif %}>Active</option>
                                    <option value="false" {% if is_active_filter == 'false' %}selected{% endif %}>Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-light"><i class="fas fa-user-tag me-1"></i>Role</label>
                                <select class="form-select" name="role">
                                    <option value="">All Roles</option>
                                    {% for value, label in roles %}
                                        <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-light"><i class="fas fa-calendar me-1"></i>Joined From</label>
                                <input type="date" class="form-control" name="join_date_from" value="{{ join_date_from }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-light"><i class="fas fa-calendar me-1"></i>Joined To</label>
                                <input type="date" class="form-control" name="join_date_to" value="{{ join_date_to }}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm me-2">
                                    <i class="fas fa-filter me-1"></i>Apply Filters
                                </button>
                                <a href="{% url 'member_list' %}" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-times me-1"></i>Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- Table View -->
                <div id="tableView">
                    <div class="table-responsive">
                        <table id="memberTable" class="table modern-table">
                        <thead>
                        <tr>
                            <th>Profile Picture</th>
                            <th>Member ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Telephone Number</th>
                            <th>Status</th>
                            <th>Date Joined</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for member in members %}
                            <tr data-member-id="{{ member.member_id }}">
                                <td class="align-middle">
                                    <div class="position-relative d-inline-block">
                                        {% if member.member_profile_picture %}
                                            <img class="rounded-circle" src="{{ member.member_profile_picture.url }}" 
                                                 alt="Profile" style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #e5e7eb;">
                                        {% else %}
                                            <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center" 
                                                 style="width: 50px; height: 50px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        {% endif %}
                                        {% if member.member_role %}
                                            <span class="position-absolute bottom-0 end-0" style="transform: translate(25%, 25%);">
                                                {% if member.member_role == 'PRESIDENT' or member.member_role == 'SECRETARY' or member.member_role == 'TREASURY' %}
                                                    <span class="badge bg-warning text-dark" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="Main Role">
                                                        <i class="fas fa-crown"></i>
                                                    </span>
                                                {% elif member.member_role == 'VICE_PRESIDENT' or member.member_role == 'VICE_SECRETARY' or member.member_role == 'VICE_TREASURY' %}
                                                    <span class="badge bg-info" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="Vice Role">
                                                        <i class="fas fa-star"></i>
                                                    </span>
                                                {% elif member.member_role == 'COMMITTEE_MEMBER' %}
                                                    <span class="badge bg-success" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="Committee Member">
                                                        <i class="fas fa-users"></i>
                                                    </span>
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <span class="member-id" data-field="member_id" data-member-id="{{ member.member_id }}">{{ member.member_id }}</span>
                                </td>
                                <td class="align-middle">
                                    <span class="editable" data-field="member_first_name" data-member-id="{{ member.member_id }}">{{ member.member_first_name }}</span>
                                </td>
                                <td class="align-middle">
                                    <span class="editable" data-field="member_last_name" data-member-id="{{ member.member_id }}">{{ member.member_last_name }}</span>
                                </td>
                                <td class="align-middle">
                                    <span class="editable" data-field="member_tp_number" data-member-id="{{ member.member_id }}">{{ member.member_tp_number }}</span>
                                </td>
                                <td class="align-middle">
                                    <span class="badge {% if member.member_is_active %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if member.member_is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td class="align-middle">{{ member.member_join_at|date:"d M Y" }}</td>
                                <td class="align-middle">
                                    {% if member.member_role %}
                                        {% if member.member_role == 'PRESIDENT' or member.member_role == 'SECRETARY' or member.member_role == 'TREASURY' %}
                                            <span class="badge bg-warning text-dark" title="Main Role">
                                                <i class="fas fa-crown"></i> {{ member.get_member_role_display }}
                                            </span>
                                        {% elif member.member_role == 'VICE_PRESIDENT' or member.member_role == 'VICE_SECRETARY' or member.member_role == 'VICE_TREASURY' %}
                                            <span class="badge bg-info" title="Vice Role">
                                                <i class="fas fa-star"></i> {{ member.get_member_role_display }}
                                            </span>
                                        {% elif member.member_role == 'COMMITTEE_MEMBER' %}
                                            <span class="badge bg-success" title="Committee Member">
                                                <i class="fas fa-users"></i> {{ member.get_member_role_display }}
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    <br>
                                    <div class="btn-group mt-2" role="group">
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-primary-modern" href="{% url 'member_view' member.member_id %}">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a class="btn btn-sm btn-warning-modern" href="{% url 'member_edit' member.member_id %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if user.is_superuser %}
                                            <a class="btn btn-sm btn-danger-modern" href="{% url 'member_delete' member.member_id %}" 
                                               onclick="return confirm('Are you sure you want to delete this member?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include 'pagination.html' %}
                </div>
                
                <!-- Cards View -->
                <div id="cardsView" style="display: none;">
                    <div class="row g-3">
                        {% for member in members %}
                            <div class="col-md-4 col-lg-3">
                                <div class="modern-card h-100 member-card" data-member-id="{{ member.member_id }}">
                                    <div class="modern-card-body text-center">
                                        <div class="mb-3">
                                            {% if member.member_profile_picture %}
                                                <img src="{{ member.member_profile_picture.url }}" 
                                                     class="rounded-circle" 
                                                     style="width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--border-color);">
                                            {% else %}
                                                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center" 
                                                     style="width: 80px; height: 80px;">
                                                    <i class="fas fa-user fa-2x text-white"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <h6 class="fw-bold mb-1">{{ member.member_first_name }} {{ member.member_last_name }}</h6>
                                        <p class="text-muted small mb-2">{{ member.member_id }}</p>
                                        <div class="mb-2">
                                            <span class="badge {% if member.member_is_active %}bg-success{% else %}bg-warning{% endif %}">
                                                {% if member.member_is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                            {% if member.member_role %}
                                                <span class="badge bg-info ms-1">{{ member.get_member_role_display }}</span>
                                            {% endif %}
                                        </div>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-phone me-1"></i>{{ member.member_tp_number }}
                                        </p>
                                        <div class="btn-group w-100">
                                            <a href="{% url 'member_view' member.member_id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'member_edit' member.member_id %}" class="btn btn-sm btn-warning">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if user.is_superuser %}
                                                <a href="{% url 'member_delete' member.member_id %}" 
                                                   class="btn btn-sm btn-danger"
                                                   onclick="return confirm('Are you sure?')">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% include 'pagination.html' %}
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function (){
            $('#memberTable').DataTable({
                paging: false,
                searching: true,
                order: [[6, 'desc']],  // Date Joined column
                columnDefs: [
                    {targets: -1, orderable: false},  // Actions column
                ],
                info: false,
                language: {
                    search: "<i class='fas fa-search'></i>",
                    searchPlaceholder: "Search members..."
                }
            });
            
            // View Toggle
            $('[id="viewToggle"]').on('click', function() {
                const view = $(this).data('view');
                if (view === 'cards') {
                    $('#tableView').hide();
                    $('#cardsView').show();
                    $(this).addClass('active');
                    $('[data-view="table"]').removeClass('active');
                } else {
                    $('#cardsView').hide();
                    $('#tableView').show();
                    $(this).addClass('active');
                    $('[data-view="cards"]').removeClass('active');
                }
            });
            
            // Inline Editing
            $('.editable').on('dblclick', function() {
                const $this = $(this);
                const currentValue = $this.text().trim();
                const field = $this.data('field');
                const memberId = $this.data('member-id');
                
                const $input = $('<input>', {
                    type: 'text',
                    class: 'form-control form-control-sm',
                    value: currentValue
                });
                
                $this.replaceWith($input);
                $input.focus().select();
                
                $input.on('blur', function() {
                    const newValue = $(this).val().trim();
                    if (newValue !== currentValue && newValue !== '') {
                        $.ajax({
                            url: '{% url "member_inline_edit" %}',
                            method: 'POST',
                            data: {
                                member_id: memberId,
                                field: field,
                                value: newValue,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(response) {
                                if (response.success) {
                                    $input.replaceWith($('<span>', {
                                        class: 'editable',
                                        'data-field': field,
                                        'data-member-id': memberId,
                                        text: newValue
                                    }));
                                } else {
                                    alert('Error: ' + response.message);
                                    $input.replaceWith($('<span>', {
                                        class: 'editable',
                                        'data-field': field,
                                        'data-member-id': memberId,
                                        text: currentValue
                                    }));
                                }
                            },
                            error: function() {
                                alert('An error occurred');
                                $input.replaceWith($('<span>', {
                                    class: 'editable',
                                    'data-field': field,
                                    'data-member-id': memberId,
                                    text: currentValue
                                }));
                            }
                        });
                    } else {
                        $input.replaceWith($('<span>', {
                            class: 'editable',
                            'data-field': field,
                            'data-member-id': memberId,
                            text: currentValue
                        }));
                    }
                });
                
                $input.on('keypress', function(e) {
                    if (e.which === 13) {
                        $(this).blur();
                    }
                });
            });
        });
    </script>

    <!-- Export Modal -->
    {% if user.is_superuser %}
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">
                        <i class="fas fa-download me-2"></i>Export Members
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'member_info_export' %}" id="exportForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Export Format</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatExcel" value="excel" checked>
                                <label class="form-check-label" for="formatExcel">
                                    <i class="fas fa-file-excel text-success me-1"></i>Excel (.xlsx)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatPdf" value="pdf">
                                <label class="form-check-label" for="formatPdf">
                                    <i class="fas fa-file-pdf text-danger me-1"></i>PDF (.pdf)
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Select Columns to Export</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="member_id" id="col_id" checked>
                                        <label class="form-check-label" for="col_id">Member ID</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="initials" id="col_initials" checked>
                                        <label class="form-check-label" for="col_initials">Initials</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="first_name" id="col_first" checked>
                                        <label class="form-check-label" for="col_first">First Name</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="last_name" id="col_last" checked>
                                        <label class="form-check-label" for="col_last">Last Name</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="address" id="col_address">
                                        <label class="form-check-label" for="col_address">Address</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="dob" id="col_dob">
                                        <label class="form-check-label" for="col_dob">Date of Birth</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="telephone" id="col_phone" checked>
                                        <label class="form-check-label" for="col_phone">Telephone</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="account" id="col_account">
                                        <label class="form-check-label" for="col_account">Account Number</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="guardian" id="col_guardian">
                                        <label class="form-check-label" for="col_guardian">Guardian Name</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="role" id="col_role" checked>
                                        <label class="form-check-label" for="col_role">Role</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="status" id="col_status" checked>
                                        <label class="form-check-label" for="col_status">Status</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="columns" value="join_date" id="col_join" checked>
                                        <label class="form-check-label" for="col_join">Join Date</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Current filters and search will be applied to the export.
                            {% if is_adults_page %}
                            <input type="hidden" name="is_adults" value="true">
                            {% endif %}
                        </div>
                        
                        <!-- Preserve current filters -->
                        {% if search_query %}
                        <input type="hidden" name="search" value="{{ search_query }}">
                        {% endif %}
                        {% if is_active_filter %}
                        <input type="hidden" name="is_active" value="{{ is_active_filter }}">
                        {% endif %}
                        {% if role_filter %}
                        <input type="hidden" name="role" value="{{ role_filter }}">
                        {% endif %}
                        {% if join_date_from %}
                        <input type="hidden" name="join_date_from" value="{{ join_date_from }}">
                        {% endif %}
                        {% if join_date_to %}
                        <input type="hidden" name="join_date_to" value="{{ join_date_to }}">
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock content %}
