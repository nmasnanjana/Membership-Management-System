{% extends 'base.html' %}
{% load static %}

{% block head %}
    <style>
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin: 20px 0;
            padding: 10px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
            overflow: hidden;
        }
        
        .heatmap-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0);
            transition: background 0.3s ease;
            pointer-events: none;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.15) translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.2);
            z-index: 100;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .heatmap-cell:hover::before {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .heatmap-cell:active {
            transform: scale(1.1) translateY(-2px);
        }
        
        .heatmap-cell .cell-date {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-bottom: 2px;
            font-weight: 500;
        }
        
        .heatmap-cell .cell-content {
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .heatmap-cell .cell-icon {
            font-size: 1rem;
        }
        
        /* Tooltip */
        .heatmap-tooltip {
            position: absolute;
            background: rgba(31, 41, 55, 0.98);
            color: #f9fafb;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .heatmap-cell:hover .heatmap-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .heatmap-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(31, 41, 55, 0.98);
        }
        
        .heatmap-tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #f9fafb;
        }
        
        .heatmap-tooltip-detail {
            font-size: 0.8rem;
            color: #d1d5db;
        }
        
        /* Color variants */
        .heatmap-cell.present {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .heatmap-cell.absent {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .heatmap-cell.unknown {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: #d1d5db;
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .heatmap-cell.rate-high {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .heatmap-cell.rate-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .heatmap-cell.rate-low {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .heatmap-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
            
            .heatmap-cell {
                border-radius: 6px;
            }
            
            .heatmap-cell:hover {
                transform: scale(1.1) translateY(-2px);
            }
            
            .heatmap-tooltip {
                font-size: 0.75rem;
                padding: 8px 12px;
            }
        }
        
        .month-section {
            margin-bottom: 30px;
        }
        
        .month-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
    </style>
{% endblock head %}

{% block content %}
    <div class="container-fluid px-3 px-md-4">
        {% include 'breadcrumb.html' %}
        
        <div class="mb-4 d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="page-title">
                <i class="fas fa-chart-area text-primary me-2"></i>Attendance Heatmap
            </h1>
            <form method="get" class="d-flex gap-2">
                <select name="member_id" class="form-select" style="width: 200px;">
                    <option value="">All Members</option>
                    {% for member in members %}
                        <option value="{{ member.member_id }}" {% if member_id == member.member_id %}selected{% endif %}>
                            {{ member.member_id }} - {{ member.member_first_name }} {{ member.member_last_name }}
                        </option>
                    {% endfor %}
                </select>
                <select name="year" class="form-select" style="width: 100px;">
                    {% for y in years %}
                        <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-1"></i>Filter
                </button>
            </form>
        </div>

        {% if selected_member %}
        <div class="modern-card mb-4">
            <div class="modern-card-body">
                <h5>
                    <i class="fas fa-user me-2"></i>{{ selected_member.member_first_name }} {{ selected_member.member_last_name }}
                    <span class="text-muted">({{ selected_member.member_id }})</span>
                </h5>
            </div>
        </div>
        {% endif %}

        <!-- Monthly Summary -->
        <div class="modern-card mb-4">
            <div class="modern-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Monthly Summary - {{ year }}
                </h5>
            </div>
            <div class="modern-card-body">
                <div class="row g-3">
                    {% for month in monthly_summary %}
                        <div class="col-md-3 col-6">
                            <div class="modern-card">
                                <div class="modern-card-body text-center">
                                    <div class="text-muted small mb-1">{{ month.month_name }}</div>
                                    <div class="h5 mb-1 fw-bold">
                                        {% if member_id %}
                                            {{ month.present }}/{{ month.total }}
                                        {% else %}
                                            {{ month.rate|floatformat:1 }}%
                                        {% endif %}
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" 
                                             style="width: {{ month.rate }}%; background: {% if month.rate >= 70 %}var(--success-color){% elif month.rate >= 40 %}var(--warning-color){% else %}var(--danger-color){% endif %};">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Heatmap -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-th me-2"></i>Attendance Heatmap
                </h5>
            </div>
            <div class="modern-card-body">
                {% if heatmap_data %}
                    <div class="heatmap-container">
                        {% for data in heatmap_data %}
                            <div class="heatmap-cell 
                                {% if member_id %}
                                    {% if data.attended is True %}present{% elif data.attended is False %}absent{% else %}unknown{% endif %}
                                {% else %}
                                    {% if data.attendance_rate >= 70 %}rate-high{% elif data.attendance_rate >= 40 %}rate-medium{% else %}rate-low{% endif %}
                                {% endif %}"
                                {% if data.meeting_id %}onclick="window.location.href='{% url 'attendance_date' data.meeting_id %}'"{% endif %}>
                                <div class="cell-date">{{ data.date|date:"d M" }}</div>
                                <div class="cell-content">
                                    {% if member_id %}
                                        {% if data.attended is True %}
                                            <i class="fas fa-check cell-icon"></i>
                                        {% elif data.attended is False %}
                                            <i class="fas fa-times cell-icon"></i>
                                        {% else %}
                                            <i class="fas fa-minus cell-icon"></i>
                                        {% endif %}
                                    {% else %}
                                        <span>{{ data.attendance_rate|floatformat:0 }}%</span>
                                    {% endif %}
                                </div>
                                <div class="heatmap-tooltip" style="bottom: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(10px);">
                                    <div class="heatmap-tooltip-title">
                                        {{ data.date|date:"l, d M Y" }}
                                    </div>
                                    <div class="heatmap-tooltip-detail">
                                        {% if member_id %}
                                            {% if data.attended is True %}
                                                <i class="fas fa-check-circle text-success me-1"></i>Present
                                            {% elif data.attended is False %}
                                                <i class="fas fa-times-circle text-danger me-1"></i>Absent
                                            {% else %}
                                                <i class="fas fa-minus-circle text-muted me-1"></i>Not Recorded
                                            {% endif %}
                                        {% else %}
                                            <i class="fas fa-users me-1"></i>{{ data.attendance_rate|floatformat:1 }}% Attendance
                                            <br>
                                            <i class="fas fa-user-check me-1"></i>{{ data.present_count }} / {{ data.total_members }} members
                                        {% endif %}
                                        {% if data.meeting_id %}
                                            <br><small style="color: #9ca3af;"><i class="fas fa-mouse-pointer me-1"></i>Click to view details</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-4 d-flex justify-content-center gap-4">
                        {% if member_id %}
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell present" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>Present</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell absent" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>Absent</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell unknown" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>Not Recorded</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell rate-high" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>High (â‰¥70%)</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell rate-medium" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>Medium (40-69%)</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="heatmap-cell rate-low" style="width: 30px; height: 30px; cursor: default;"></div>
                                <span>Low (&lt;40%)</span>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-center text-muted py-4">No data available for the selected period</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock content %}

